
HOSTNAMECTL
hostnamectl set-hostname <hostname>; exec bash.


Настройка IP-адресов в системе Debian
/etc/network/interfaces
Просмотр существующих интерфейсов выполняется командой
ip a 
а = вывести IP-адресацию.

После определения подключения всех интерфейсов, можно переходить к настройке. Сетевые параметры интерфейсов в Debian 11 располагаются в файле 
/etc/network/interfaces. Он открывается с помощью любого текстового редактора, например nano
nano /etc/network/interfaces

Правила настройки
auto <interface_name>1 — автоматическое включение интерфейса;
iface <interface_name>2
inet static — перевод интерфейса в режим статического IP.
Также, в случае, если необходимо настроить получение адреса динамически, через 
протокол DHCP, то следует указать запись:
iface <interface_name>2
inet dhcp;
address <IP>/<MASK>3 — установка IP-адреса и маски подсети;
gateway <gateway>4 — шлюз по умолчанию;
1<interface_name> — имя сетевого интерфейса;
2<IP> — IP-адрес в соответствии с топологией;
3<MASK> — маска подсети в соответствии с топологией;
4<gateway> — IP-адрес шлюза по умолчанию. Для оконечных устройств шлюзом будет являться вышестоящий маршрутизатор или сетевой экран.

Пример
auto lo
iface lo inet loopback

auto ens33 ens 34 ens 35 ens 36
inface ens 35 inet dhcp

iface ens 33 inet static
        address 3.3.3.1./24

iface ens 34 inet static
        address 3.3.3.1./24

iface ens 35 inet static
        address 3.3.3.1./24

iface ens 36 inet static
        address 3.3.3.1./24

После настройки конфигурационного файла /etc/network/interfaces необходимо перезапустить службу \
networking (на всех виртуальных машинах, где производилась настройка): 
systemctl restart networking.

На всех сетевых устройствах необходимо включить ip forwarding для 
включения маршрутизации на оборудовании.
На устройствах выполняющих передачу пакетов необходимо записать следующую команду 
echo “net.ipv4.ip_forward=1” > /etc/sysctl.conf; sysctl -p

echo — утилита, которая возвращает текст, переданный ей в качестве аргумента. По 
умолчанию возврат происходит в stdout (в текущую сессию терминала), но можно перенаправить вывод в файл при помощи указателя « > »;
net.ipv4.ip_forward=1 — параметр ядра, разрешающий пересылку пакетов между интерфейсами;
/etc/sysctl.conf — файл, в котором хранятся опции ядра;
sysctl -p — команда, которая читает файл /etc/sysctl.conf и применяет перечисленные в 
нем параметры.

Трансляция сетевых адресов (Network Address Translation, NAT) — это подмена какого-либо адреса или порта в пакете. 
Она, как правило, требуется на границе между сетью компании и провайдером Интернет.
Настроить NAT можно с использованием разных пакетов. В качестве примера можно использовать nftables. 
Настройка производится при помощи описания конфигурации в файле /etc/nftables.conf


nano /etc/nftables

flush ruleset
table inet filter {
        chain input {
                type filter hook input priority 0;
        }
        chain forward {
                type filter hook forward priority 0;
        }
        chain output {
                type filter hook output priority 0;
        }
}

table ip nat {
        chain postrouting {
                type nat hook postrouting priority 0;
                ip saddr *.*.*.*/24 oifname ens35 counter masquerade
       }
}


Пояснение касательно настроек в конфигурационных файлах:
#!/usr/sbin/nft -f — системная конструкция указывает, что чтение данного файла нужно произвести при помощи команды /usr/sbin/nft -f;
flush ruleset — очистить все существующие правила перед записью новых;
table ip nat {} — создание таблицы с названием nat. Использование протокола IPv4;
chain postrouting {} — создание цепочки с названием postrouting;
type nat — тип цепочки=nat;
hook postrouting — только трафик, прошедший процесс маршрутизации, попадает в 
эту цепочку;
priority 0 — цепочка выполняется самой первой для трафика;
ip saddr — указывает подсеть, трафик из которой должен попасть в nat;
oifname — имя интерфейса, на который был смаршрутизирован трафик;
counter — ключевое слово для подсчета пакетов, попавших в данное правило;
masquerade — действие, производимое с трафиком (трансляция в адрес исходящего 
интерфейса).

Данное правило можно прочитать как «В таблице nat, которая работает только с IPv4-
трафиком, на этапе, когда трафик прошел процесс маршрутизации, необходимо выбрать пакеты только из подсети *.*.*.* с 24 маской, идущие на интерфейс ens35, посчитать их и 
произвести трансляцию в адрес исходящего интерфейса».

Для проверки корректности написания правил и немедленного применения можно 
выполнить команду nft -f /etc/nftables.conf

На данном этапе, в случае ошибок в правописании команд, программа nftables отправит отчет, где подчеркнет опечатку.
После того, как правила были успешно применены, можно посмотреть список правил 
и счетчики при помощи команды nft list ruleset.

Для того чтобы активировать правила после перезагрузки, в поставке nftables присутствует сервис 
nftables, по умолчанию он выключен. Необходимо добавить его в автозагрузку 
и активировать при помощи команды systemctl enable --now nftables.

После этого можно на практике проверить работоспособность конфигурации. Для 
этого достаточно выполнить с WEB-L, WEB-R или SRV трассировку до сервера ISP при помощи команды traceroute -n 5.5.5.1

Сети, подключенные к ISP, считаются внешними:
– запрещено прямое попадание трафика из внутренних сетей во внешние и наоборот.
Так как внутренние сети теперь расположены за NAT-трафик из внешних сетей не 
сможет попасть к ним напрямую. Данный пункт выполнен в связи с настройками NAT

Сначала необходимо создать GRE-туннель для обеспечения незащищенного соединения между регионами. 
Для его настройки на каждой машине создается скрипт конфигурирования туннеля по пути — /etc/gre.up.

Описание применимых команд
ip tunnel add <имя_интерфейса> — команда для создания туннеля;
mode gre — указываем режим инкапсуляции gre;
local — адрес источника, откуда будет происходить подключение;
remote — адрес назначения, куда будет происходить подключение;
ip addr add <адрес/маска_подсети> dev <имя_интерфейса> — команда для добавления 
IP-адреса на интерфейс;
ip link set up <имя_интерфейса> — команда, включающая интерфейс;
ip route add <адрес_сети_региона/маска_подсети> via <туннельный_адрес_роутера_
напротив> — команда для добавления маршрута в сеть другого региона, таким образом мы 
сразу же добавим в автонастройку подключение сетей двух регионов.
После того, как скрипты были написаны, необходимо дать им права на выполнение 
при помощи команды
chmod +x /etc/gre.up



Проверить корректность работы скриптов можно их выполнением при помощи команды 
/etc/gre.up — такой командой передается скрипт на выполнение операционной системой.

После этого необходимо добавить скрипт в автозагрузку. 
Для этого на RTR-R и RTRL редактируется файл /etc/crontab и в конце добавляется строка @reboot root /etc/gre.up

После выполнения команды должен появиться туннельный интерфейс, также проверяется соединение в рамках туннеля с помощью утилиты ping.

Незащищенное соединение между регионами настроено, осталось его защитить. Защита соединения производится при помощи стандарта IPSec. Стандарт IPSec в Debian 11 реализуется пакетом strongswan. В первую очередь необходимо установить данный пакет на 
RTR-R и RTR-L при помощи команды apt install strongswan

После успешной установки пакета необходимо добавить конфигурацию в два основных конфигурационных файла: /etc/ipsec.conf и /etc/ipsec.secrets.
В файле /etc/ipsec.conf содержится основная информация о параметрах соединения, ниже представлены примеры на RTR-L и RTR-R:

RTR-R                                             RTR-R
conn vpn                                          conn vpn
auto=start                                        auto=start
type=tunnel                                       type=tunnel 
authby=secret                                     authby=secret 
left=5.5.5.100                                    left=4.4.4.100
right=4.4.4.100                                   right=5.5.5.100
leftsubnet=0.0.0.0/0                              leftsubnet=0.0.0.0/0
rightsubnet=0.0.0.0/0                             rightsubnet=0.0.0.0/0
leftprotoport=gre                                 leftprotoport=gre
rightprotoport=gre                                rightprotoport=gre
ike=aes128-sha256-modp3072                        ike=aes128-sha256-modp3072
esp=aes128-sha256                                 esp=aes128-sha256

conn vpn — создание соединения с именем vpn;
auto=start — запускать соединение автоматически при старте демона IPSec;
type=tunnel — указывает IPSec работать в туннельном режиме. Туннельный режим работы шифрует изначальный IP-пакет полностью и добавляет новый заголовок IP. Транспортный 
режим работы шифрует все, что выше уровня IP, а заголовок IP оставляет без изменений.
Грубо говоря, туннельный режим используется для того, чтобы связать две приватные 
сети через публичную, обеспечив при этом шифрование (что-то вроде безопасного GRE). 
Транспортный же актуален тогда, когда IP-связность уже достигнута, но трафик между узлами нужно шифровать;
authby=secret — указывает IPSec на аутентификацию по ключу из файла 
/etc/ipsec.secrets;
left — указывает локальный адрес (откуда подключаемся);
right — указывает удаленный адрес (куда подключаемся);
leftsubnet — локальные подсети, трафик из которых необходимо шифровать;
rightsubnet — удаленные подсети, трафик к которым необходимо шифровать;
leftprotoport — локальный транспортный протокол для шифрования;
rightprotoport — удаленный транспортный протокол для шифрования;
ike — параметры первой фазы IPSec;
esp — параметры второй фазы IPSec.
Файл /etc/ipsec.secrets на обоих хостах одинаковый.

4.4.4.100 5.5.5.100 : PSK "P@ssw0rd"


Комментарии к настройке
Указываются два публичных IP-адреса, которые используются для создания туннеля. 
Порядок их записи не важен. Далее разделитель в виде двоеточия. 
PSK — Pre-Shared Key — в криптографии предварительный общий ключ — это общий секретный ключ, который принят между двумя сторонами, использующими некоторый 
защищенный канал, прежде чем его нужно зашифровать.
Далее указывается секрет\пароль, он должен быть одинаковым для обеих сторон. 
После того, как конфигурация написана, необходимо добавить в автозагрузку и запустить IPSec при помощи команды
systemctl enable --now ipsec
Как проверить
Проверить работоспособность защищенного соединения можно при помощи команды 
IPSec Status. Если не показывает соединения, то запускаем IPSec Update, затем IPSec 
Restart — программа выдаст сообщение об ошибке синтаксиса в конфигах (строчку):

НАСТРОЙКА СПИСКОВ КОНТРОЛЯ ДОСТУПА
Задание 1. Платформа управления трафиком RTR-L выполняет контроль входящего 
трафика согласно следующим правилам:
– разрешаются подключения к портам DNS, HTTP и HTTPS для всех Клиентов;
– порты необходимы для работы настраиваемых служб;
– разрешается работа выбранного протокола организации защищенной связи;
– разрешение портов должно быть выполнено по принципу «необходимо и достаточно»;
– разрешается работа протокола ICMP;
– разрешается работа протокола SSH;
– прочие подключения запрещены;
– для обращений к платформам со стороны хостов, находящихся внутри регионов, 
ограничений быть не должно.
Как делать

Для настройки межсетевого экрана используется знакомый nftables. Внутри файла 
/etc/nftables.conf необходимо добавить новую таблицу записей table inet filter

flush ruleset

table inet filter {
        chain input {
                type filter hook input priority 0:
                udp dport 53 accept; #1
                udp dport 80 accept; #2
                udp dport 443 accept; #3
                ct state {established, related} accept; #4
                ip protocol gre accept; #5
                ip protocol icmp accept; #6
                udp dport 500 accept; #7

не закончено

Стоит обратить внимание на то, что в правилах nftables присутствует нумерация правил, ссылки на них можно прочитать ниже:
– разрешает работу DNS (порт 53, зарегистрированный IANA);
– разрешает работу HTTP (порт 80, зарегистрированный IANA);
– разрешает работу HTTPS (порт 443, зарегистрированный IANA);
– отслеживание состояния соединений;
– разрешает работу GRE;
– разрешает работу ICMP;
– разрешает работу IPSec (порт 500, зарегистрированный IANA);
– разрешает обращение клиентов из офиса Left;
– разрешает обращение клиентов из офиса Right;
– запрещает весь прочий трафик по протоколу IPv4.

Как проверить
После написания конфигурации необходимо применить правила при помощи команды nft -f /etc/nftables.conf.
Также можно использовать команду nft list ruleset, чтобы отобразить список всех текущих настроек

Задание 2. Платформа управления трафиком RTR-R выполняет контроль входящего 
трафика согласно следующим правилам:
– разрешаются подключения к портам HTTP и HTTPS для всех клиентов;
– порты необходимы для работы настраиваемых служб;
– разрешается работа выбранного протокола организации защищенной связи;
– разрешение портов должно быть выполнено по принципу «необходимо и достаточно»;
– разрешается работа протоколов ICMP;




