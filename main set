
HOSTNAMECTL
hostnamectl set-hostname <hostname>; exec bash.


Настройка IP-адресов в системе Debian
/etc/network/interfaces
Просмотр существующих интерфейсов выполняется командой
ip a 
а = вывести IP-адресацию.

После определения подключения всех интерфейсов, можно переходить к настройке. Сетевые параметры интерфейсов в Debian 11 располагаются в файле 
/etc/network/interfaces. Он открывается с помощью любого текстового редактора, например nano
nano /etc/network/interfaces

Правила настройки
auto <interface_name>1 — автоматическое включение интерфейса;
iface <interface_name>2
inet static — перевод интерфейса в режим статического IP.
Также, в случае, если необходимо настроить получение адреса динамически, через 
протокол DHCP, то следует указать запись:
iface <interface_name>2
inet dhcp;
address <IP>/<MASK>3 — установка IP-адреса и маски подсети;
gateway <gateway>4 — шлюз по умолчанию;
1<interface_name> — имя сетевого интерфейса;
2<IP> — IP-адрес в соответствии с топологией;
3<MASK> — маска подсети в соответствии с топологией;
4<gateway> — IP-адрес шлюза по умолчанию. Для оконечных устройств шлюзом будет являться вышестоящий маршрутизатор или сетевой экран.

Пример
auto lo
iface lo inet loopback

auto ens33 ens 34 ens 35 ens 36
inface ens 35 inet dhcp

iface ens 33 inet static
        address 3.3.3.1./24

iface ens 34 inet static
        address 3.3.3.1./24

iface ens 35 inet static
        address 3.3.3.1./24

iface ens 36 inet static
        address 3.3.3.1./24

После настройки конфигурационного файла /etc/network/interfaces необходимо перезапустить службу \
networking (на всех виртуальных машинах, где производилась настройка): 
systemctl restart networking.

На всех сетевых устройствах необходимо включить ip forwarding для 
включения маршрутизации на оборудовании.
На устройствах выполняющих передачу пакетов необходимо записать следующую команду 
echo “net.ipv4.ip_forward=1” > /etc/sysctl.conf; sysctl -p

echo — утилита, которая возвращает текст, переданный ей в качестве аргумента. По 
умолчанию возврат происходит в stdout (в текущую сессию терминала), но можно перенаправить вывод в файл при помощи указателя « > »;
net.ipv4.ip_forward=1 — параметр ядра, разрешающий пересылку пакетов между интерфейсами;
/etc/sysctl.conf — файл, в котором хранятся опции ядра;
sysctl -p — команда, которая читает файл /etc/sysctl.conf и применяет перечисленные в 
нем параметры.

Трансляция сетевых адресов (Network Address Translation, NAT) — это подмена какого-либо адреса или порта в пакете. 
Она, как правило, требуется на границе между сетью компании и провайдером Интернет.
Настроить NAT можно с использованием разных пакетов. В качестве примера можно использовать nftables. 
Настройка производится при помощи описания конфигурации в файле /etc/nftables.conf


nano /etc/nftables

flush ruleset
table inet filter {
        chain input {
                type filter hook input priority 0;
        }
        chain forward {
                type filter hook forward priority 0;
        }
        chain output {
                type filter hook output priority 0;
        }
}

table ip nat {
        chain postrouting {
                type nat hook postrouting priority 0;
                ip saddr *.*.*.*/24 oifname ens35 counter masquerade
       }
}


Пояснение касательно настроек в конфигурационных файлах:
#!/usr/sbin/nft -f — системная конструкция указывает, что чтение данного файла нужно произвести при помощи команды /usr/sbin/nft -f;
flush ruleset — очистить все существующие правила перед записью новых;
table ip nat {} — создание таблицы с названием nat. Использование протокола IPv4;
chain postrouting {} — создание цепочки с названием postrouting;
type nat — тип цепочки=nat;
hook postrouting — только трафик, прошедший процесс маршрутизации, попадает в 
эту цепочку;
priority 0 — цепочка выполняется самой первой для трафика;
ip saddr — указывает подсеть, трафик из которой должен попасть в nat;
oifname — имя интерфейса, на который был смаршрутизирован трафик;
counter — ключевое слово для подсчета пакетов, попавших в данное правило;
masquerade — действие, производимое с трафиком (трансляция в адрес исходящего 
интерфейса).

Данное правило можно прочитать как «В таблице nat, которая работает только с IPv4-
трафиком, на этапе, когда трафик прошел процесс маршрутизации, необходимо выбрать пакеты только из подсети *.*.*.* с 24 маской, идущие на интерфейс ens35, посчитать их и 
произвести трансляцию в адрес исходящего интерфейса».

Для проверки корректности написания правил и немедленного применения можно 
выполнить команду nft -f /etc/nftables.conf

На данном этапе, в случае ошибок в правописании команд, программа nftables отправит отчет, где подчеркнет опечатку.
После того, как правила были успешно применены, можно посмотреть список правил 
и счетчики при помощи команды nft list ruleset.

Для того чтобы активировать правила после перезагрузки, в поставке nftables присутствует сервис 
nftables, по умолчанию он выключен. Необходимо добавить его в автозагрузку 
и активировать при помощи команды systemctl enable --now nftables.

После этого можно на практике проверить работоспособность конфигурации. Для 
этого достаточно выполнить с WEB-L, WEB-R или SRV трассировку до сервера ISP при помощи команды traceroute -n 5.5.5.1

Сети, подключенные к ISP, считаются внешними:
– запрещено прямое попадание трафика из внутренних сетей во внешние и наоборот.
Так как внутренние сети теперь расположены за NAT-трафик из внешних сетей не 
сможет попасть к ним напрямую. Данный пункт выполнен в связи с настройками NAT

Сначала необходимо создать GRE-туннель для обеспечения незащищенного соединения между регионами. 
Для его настройки на каждой машине создается скрипт конфигурирования туннеля по пути — /etc/gre.up.

Описание применимых команд
ip tunnel add <имя_интерфейса> — команда для создания туннеля;
mode gre — указываем режим инкапсуляции gre;
local — адрес источника, откуда будет происходить подключение;
remote — адрес назначения, куда будет происходить подключение;
ip addr add <адрес/маска_подсети> dev <имя_интерфейса> — команда для добавления 
IP-адреса на интерфейс;
ip link set up <имя_интерфейса> — команда, включающая интерфейс;
ip route add <адрес_сети_региона/маска_подсети> via <туннельный_адрес_роутера_
напротив> — команда для добавления маршрута в сеть другого региона, таким образом мы 
сразу же добавим в автонастройку подключение сетей двух регионов.
После того, как скрипты были написаны, необходимо дать им права на выполнение 
при помощи команды
chmod +x /etc/gre.up



Проверить корректность работы скриптов можно их выполнением при помощи команды 
/etc/gre.up — такой командой передается скрипт на выполнение операционной системой.

После этого необходимо добавить скрипт в автозагрузку. 
Для этого на RTR-R и RTRL редактируется файл /etc/crontab и в конце добавляется строка @reboot root /etc/gre.up




